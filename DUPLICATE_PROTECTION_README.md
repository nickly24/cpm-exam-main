# Защита от дублирования тест-сессий

## Проблема

При многократном нажатии кнопки "Завершить тест" студентами в базе данных создавались дублирующие записи тест-сессий.

## Решение

Реализована многоуровневая защита от дублирования:

### 1. Проверка на уровне приложения

- В функции `create_test_session()` добавлена проверка существования сессии перед созданием новой
- Если сессия уже существует, возвращается ошибка с информацией о существующей сессии

### 2. Уникальный индекс в базе данных

- Создан составной уникальный индекс по полям `studentId` и `testId`
- Индекс создается автоматически при запуске приложения

### 3. Обработка исключений

- Добавлена обработка `DuplicateKeyError` для случаев race condition
- При возникновении исключения возвращается информация о существующей сессии

## Изменения в коде

### create_test_session.py

- Модифицирована функция `create_test_session()` для возврата структурированного ответа
- Добавлена функция `ensure_unique_index()` для создания уникального индекса
- Добавлена обработка `DuplicateKeyError`

### main.py

- Обновлен маршрут `/create-test-session` для обработки нового формата ответа
- При дублировании возвращается HTTP статус 409 (Conflict)

## API Response Format

### Успешное создание сессии

```json
{
  "id": "session_id_here"
}
```

### Ошибка дублирования

```json
{
  "error": "Тест уже сдан",
  "message": "Для данного студента и теста уже существует завершенная сессия",
  "existingSessionId": "existing_session_id",
  "existingScore": 85,
  "completedAt": "2024-01-01T00:00:00.000Z"
}
```

## Тестирование

Запустите тестовый скрипт для проверки работы защиты:

```bash
python test_duplicate_protection.py
```

## HTTP Status Codes

- `200` - Сессия успешно создана
- `409` - Конфликт (тест уже сдан)
- `400` - Ошибка валидации данных

## Безопасность

- Защита работает на уровне базы данных
- Предотвращает race conditions
- Сохраняет целостность данных
- Возвращает информативные сообщения об ошибках
